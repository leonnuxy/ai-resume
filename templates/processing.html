<!DOCTYPE html>
<html>

<head>
    <title>Processing Resume</title>
    <style>
        /* Basic styling for better readability */
        body {
            font-family: sans-serif;
            line-height: 1.6;
            margin: 2em;
        }

        h1,
        h2 {
            color: #333;
        }

        #result {
            margin-top: 1em;
            padding: 1em;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .suggestion-section {
            margin-bottom: 1em;
        }

        .suggestion-section h4 {
            margin-bottom: 0.5em;
            color: #555;
        }

        .suggestion-section ul {
            list-style: disc;
            margin-left: 20px;
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 1em auto;
            display: none; /* Initially hidden */
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div id="result">
         </div>

    <script>
        function checkTaskStatus(taskId) {
            fetch(`/status/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    const resultDiv = document.getElementById('result');

                    if (data.state === 'SUCCESS') {
                        // Check if data.result is defined and has the expected structure
                        if (data.result && data.result.analysis && data.result.suggestions) {
                            const formattedSuggestions = data.result.suggestions.map(suggestion => {
                                // Handle both string and object suggestions
                                if (typeof suggestion === 'string') {
                                    return `<li>${suggestion}</li>`;
                                } else if (typeof suggestion === 'object' && suggestion !== null && suggestion.title && suggestion.details) {
                                    return `<li><strong>${suggestion.title}</strong>: ${suggestion.details}</li>`;
                                }
                                return ''; // Skip if the format is unexpected
                            }).join('');

                            // Build the HTML for analysis results
                            let analysisHtml = '<h2>Analysis Result:</h2>';

                            // Helper function to safely access properties
                            const getProp = (obj, path, defaultValue = '') => {
                                return path.split('.').reduce((acc, part) => acc && acc[part] ? acc[part] : defaultValue, obj);
                            }

                            // Helper function to safely create list
                            const createList = (items, title) => {
                                if (items && items.length > 0) {
                                    return `<p><strong>${title}:</strong> ${items.join(', ')}</p>`;
                                }
                                return '';
                            }

                            analysisHtml += createList(getProp(data.result, 'missing_skills', []).map(item => item.skill), 'Missing Key Skills');
                            analysisHtml += createList(getProp(data.result, 'improvement_suggestions', []).map(item => `${item.current} -> ${item.suggested}`), "Improvement suggestions");
                            analysisHtml += createList(getProp(data.result, 'emphasis_suggestions', []).map(item => item.experience), "Experiences to emphasize");
                            analysisHtml += createList(getProp(data.result, 'general_suggestions'), "General Suggestions");

                            // Add other parts of the analysis *only if they exist*
                            if (data.result.analysis) {
                                analysisHtml += createList(getProp(data.result.analysis, 'missing_keywords'), 'Missing Keywords');
                                analysisHtml += createList(getProp(data.result.analysis, 'action_verbs'), 'Action Verbs');
                                analysisHtml += createList(getProp(data.result.analysis, 'metrics'), 'Metrics');
                                analysisHtml += createList(getProp(data.result.analysis, 'soft_skills'), 'Soft Skills');
                                analysisHtml += createList(getProp(data.result.analysis, 'hard_skills'), 'Hard Skills');

                                if(data.result.analysis.sentences_complexity_score) {
                                    analysisHtml += `<p><strong>Sentences Complexity Score:</strong> ${data.result.analysis.sentences_complexity_score}</p>`;
                                }
                                if(data.result.analysis.overall_readability_score){
                                     analysisHtml += `<p><strong>Overall Readability Score:</strong> ${data.result.analysis.overall_readability_score}</p>`;
                                }

                            }


                            analysisHtml += `<p><strong>Suggestions:</strong></p><ul>${formattedSuggestions}</ul>`;

                            resultDiv.innerHTML = analysisHtml;


                        } else {
                            // Handle the case where data.result is malformed
                            resultDiv.innerHTML = '<p>An error occurred while processing the results.</p>';
                        }


                    } else if (data.state === 'FAILURE') {
                        resultDiv.innerHTML = `<p>An error occurred: ${data.status}</p>`;
                    } else {
                        // Task is still running, check again in a few seconds
                        resultDiv.innerHTML = '<div class="loading-spinner"></div><p>Processing...</p>';  // Show loading spinner
                        setTimeout(() => checkTaskStatus(taskId), 2000);
                    }
                })
                .catch(error => {
                    console.error("Error fetching task status:", error);
                    const resultDiv = document.getElementById('result');
                    resultDiv.innerHTML = '<p>An error occurred while fetching task status.</p>';
                });
        }

        window.onload = () => {
            const taskId = "{{ task_id }}";  // Get the task ID from the template
            checkTaskStatus(taskId);
        };
    </script>
</body>

</html>